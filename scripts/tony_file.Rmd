---
title: "tony_file"
author: "Tony Daza"
date: "2023-03-16"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true 
    code_folding: hide
    theme: cerulean
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(psych)
library(rio)
library(lme4)  
library(Rmisc)
library(sjPlot)
library(rempsyc)
library(DT)
library(here)
library(naniar)
library(performance)
library(sjPlot)
library(interactions) 
```

# Innovative School Practices   
## Importing the Data  

Thank you Janette for compiling the data!

```{r import}

load(here("data/canopy-schools.RData"))


```

*After looking at the data, I think we need to combine the tags into one variable as a count of number of practices if we are going to run the model as suggested*

## Counting Number of Practices  

```{r count}
main$prac_tot <- rowSums(main[c(5,6,7,8,9,10,11,12,13)], na.rm=TRUE)

main <- main %>% mutate_at(c('locale'), ~na_if(.,''))

main$locale <- as.factor(main$locale)


summary(main)

# Looks like we have 6 NA value schools now for Locale. 
## 91 NA values for bipoc.  
## 1117 NA values for frpl.  

```

## Examining data to model   

```{r desript}

main %>%
  filter(locale != "NA") %>%
  group_by(locale) %>%
ggplot(aes(x = wave, y = prac_tot )) +           
  geom_bar(stat = "summary", fun = "mean", fill="cornflowerblue") + 
  facet_grid(~locale) + 
  theme_classic()+
  labs(y = "Total Practices", x = "Wave")


```


```{r}

datatable(round(describe(main[5:19], fast = TRUE, ranges = FALSE), digits = 2))

```


## Missing Data  

Here we are running an MCAR test to examing to see if the missing data for locale, free and reduced price lunch, and percent bipoc is missing at random. If it is at random then we will continue as planned. If not, we will use imputed data.

```{r missing, warning=FALSE, message=FALSE, eval=FALSE}

mcar_test(main)
```

There is an error which I don't know how to read.

## Fixed Effects  

This is how he did assignment 3 where we first examined if practices changed overtime in general without any predictors. 

```{r}
main$cwave <- c(scale(main$wave, center = TRUE, scale =TRUE))
main$cbipoc_percent <- c(scale(main$bipoc_percent,  center=TRUE, scale=TRUE)) 
main$cfrpl_percent <- c(scale(main$frpl_percent,  center=TRUE, scale=TRUE))

GLMMfix0 <- glmer(prac_tot ~ 1 + wave + (1|school_id), 
                  family = poisson, 
                  data = main) 
summary(GLMMfix0)

```
In this case, wave does seem to be significant. 

## Model with predictors  

Here we are adding in locale, percent bipoc, and percent frpl as predictors in our model. 

```{r}

GLMMfix <- glmer(prac_tot ~ 1 + wave + locale + bipoc_percent + frpl_percent + (1|school_id), 
                  family = poisson, 
                  data = main) 
## Not happy. Model failed to converge
## Will try to rescale variables

```

## Model Rescaled predictors   

The previous model failed to converge. I rescaled the predictors and now it converges. In this model we also have the interaction between wave and locale but not of percent bipoc and percent frpl.  


**The model did not converge without scaling the data. Why is that?**

```{r}


GLMMfix1 <- glmer(prac_tot ~ 1 + cwave + 
                    locale + 
                    cbipoc_percent + 
                    cfrpl_percent + 
                    locale*cwave +
                    (1|school_id), 
                  family = poisson, 
                  data = main) 
summary(GLMMfix1)
tab_model(GLMMfix1)


```

**ICC: 0.21**

**Marginal R^2: 0.216 (21.6% of variance explained)**

**Conditional R^2: 0.378 (37.8% of variance explained)**

In this model it seems like the interaction between wave and urban location was significant but not for suburban and wave. 

### Model check   
Is this any better than the unconditional model? 

```{r, warning=FALSE, message=FALSE}

AIC(GLMMfix0,GLMMfix1)
BIC(GLMMfix0,GLMMfix1)

## Cannot compare because different proportion of missing data.  
# test_lrt(GLMMfix0,GLMMfix1) 

```

Based on AIC and BIC the model with predictors is a better fit.  

## Predictors of growth  

If I understand correctly, I think this adds percent bipoc and percent frpl as predictors of growth. 

```{r}

GLMMfix2 <- glmer(prac_tot ~ 1 + cwave + 
                    locale + 
                    cbipoc_percent + 
                    cfrpl_percent + 
                    locale*cwave +
                    cbipoc_percent*cwave +
                    cfrpl_percent*cwave +
                    (1|school_id), 
                  family = poisson, 
                  data = main) 
summary(GLMMfix2)

## Model failed to converge. 

```

This model does not converge. 

## Test for improvement of fit

```{r}

test_lrt(GLMMfix1,GLMMfix2)

```

The second model does not seem to be better which would make sense given that we likely wouldn't expect percent frpl and percent bipoc to change significantly in a short timeframe and adding the interactions of those two with wave increased our degrees of freedom.

# Plots  

```{r, warning=FALSE, message=FALSE}
plot_model(GLMMfix1) + theme_classic () 

plot_model(GLMMfix1,type = "eff")$cwave + theme_classic () # plot the effect of Time (Wave) 

plot_model(GLMMfix1,type = "eff")$locale + theme_classic () # plot the effect of locale 
 
interact_plot(model=GLMMfix1, pred = cwave, modx = locale) # Enter the predictor of growth in the final model 
```




**No Idea if what I did above is correct**

## Another Plot  

```{r, warning=FALSE, message=FALSE}
localegg <- summarySE(na.omit(main), measurevar="prac_tot", groupvars=c("locale","wave")) 

localegg$wave<-as.numeric(localegg$wave)

# The errorbars overlapped, so use position_dodge to move them horizontally
pd <- position_dodge(0.1) # move them .05 to the left and right

# Use 95% confidence interval instead of SEM

ggplot(localegg, aes(x=wave, y=prac_tot, color=locale)) + 
  geom_errorbar(aes(ymin=prac_tot-ci, ymax=prac_tot+ci), width=.1, position=pd) +
  ylab("Total Practices") +
  ylim(0,9) +
  geom_line(position=pd) +
  geom_point(position=pd) + theme_classic() + 
  scale_color_manual(values=c("cornflowerblue", "chocolate1", "darkorchid2")) +
  ggtitle("Locale x Group By Time with 95% Mean CIs") +
  theme(plot.title = element_text(hjust = 0.5, lineheight=.8, face="bold"))
  

```


# Growth model Random Effect  

Unsure if we want to include random effects for the growth model. I think it would be for wave but not sure.  

```{r}


# GLMMran1 <- glmer(prac_tot ~ 1 + wave + 
#                      locale + 
#                      bipoc_percent + 
#                      frpl_percent + 
#                      locale*wave +
#                      (1+wave|school_id), 
#                    family = poisson, 
#                    data = main) 
# summary(GLMMran1)



```
I am getting an error that the number of random effects is greater than the number of observations.  


# Imputed Data

If needed, here is the model with imputed data, if the MCAR test determines that the missing data is not at random. 

```{r}
library(lmerTest)
library(mice)
library(broom.mixed)
library(mitml)

md.pattern(main, rotate.names = T)


```

Tells us where the missing data is though I don't completely know how to read it. 

Okay this is from stackoverflow and is suggested as a way to manage missing data. It allows me to run the model, but I am not sure it is needed.

```{r}
#Someone online suggested this package to impute data

#### Impute ####
imp <- mice(main,
            m=5)

#### Fit With Imputations ####
fit <- with(imp,
            glmer(prac_tot ~ locale + cwave + 
                   cbipoc_percent+
                   cfrpl_percent+
                   locale*cwave+
                   cbipoc_percent*cwave+
                   cfrpl_percent*cwave+
                   (1|school_id)))

#### Pool and Summarise ####
pool <- pool(fit)
summary(pool)


#### Load Library and Get All Estimates ####
testEstimates(as.mitml.result(fit),
              extra.pars = T)
```


