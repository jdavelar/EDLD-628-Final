---
title: "tony_file"
author: "Tony Daza"
date: "2023-03-16"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true 
    code_folding: hide
    theme: cerulean
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(psych)
library(rio)
library(lme4)  
library(Rmisc)
library(sjPlot)
library(rempsyc)
library(DT)
library(here)
library(naniar)
library(performance)
library(sjPlot)
library(interactions) 
```

# Innovative School Practices   
## Importing the Data  

Thank you Janette for compiling the data!

```{r import}

load(here("data/canopy-schools.RData"))


```

*After looking at the data, I think we need to combine the tags into one variable as a count of number of practices if we are going to run the model as suggested*

## Counting Number of Practices  

```{r count}
main$prac_tot <- rowSums(main[c(5,6,7,8,9,10,11,12,13)], na.rm=TRUE)

main <- main %>% mutate_at(c('locale'), ~na_if(.,''))

main$locale <- as.factor(main$locale)


summary(main)

# Looks like we have 6 NA value schools now for Locale. 
## 91 NA values for bipoc.  
## 117 NA values for frpl.  

```

## Examining data to model   

```{r desript plot}

main %>%
  filter(locale != "NA") %>%
  group_by(locale) %>%
ggplot(aes(x = wave, y = prac_tot )) +           
  geom_bar(stat = "summary", fun = "mean", fill="cornflowerblue") + 
  facet_grid(~locale) + 
  theme_classic()+
  labs(y = "Total Practices", x = "Wave")


```

### Descriptive Table  

```{r descriptive table}

datatable(round(describe(main[5:19], fast = TRUE, ranges = FALSE), digits = 2))

```

### Distribution: 

```{r practice distribution}
main %>%
  ggplot(aes(x = prac_tot)) +
  geom_bar(fill= "darkorchid2") +
  theme_minimal()

```

## Missing Data  

Here we are running an MCAR test to examing to see if the missing data for locale, free and reduced price lunch, and percent bipoc is missing at random. If it is at random then we will continue as planned. If not, we will use imputed data.

```{r missing, warning=FALSE}

 
main$cbipoc_percent <- c(scale(main$bipoc_percent,  center=TRUE, scale=TRUE)) 
main$cfrpl_percent <- c(scale(main$frpl_percent,  center=TRUE, scale=TRUE))

main_mcar <- main %>%
  select(wave, frpl_percent, locale, bipoc_percent, prac_tot)

main_mcar$locale <- as.numeric(main_mcar$locale)

mcar_test(main_mcar)




```

There is a difference between complete cases and partial cases. Code complete and partial data and run t tests to try to predict difference between cases. If there is a mean difference, we should add that as a control in the model. 

Attrition analysis: examine schools that participated over all 3 waves
Examine means test of the two groups and report that.

**Only impute data if missing completely at random**

In this case though, because we know the reason for why it is missing might make sense. 


## Fixed Effects  

This is how he did assignment 3 where we first examined if practices changed overtime in general without any predictors. 

```{r conditional, warning=FALSE, message=FALSE}



GLMMCond <- glmer(prac_tot ~ 1 + wave + (1|school_id), 
                  family = poisson, 
                  data = main) 
summary(GLMMCond)
tab_model(GLMMCond)

```

**ICC: 0.29**

Total observations 566 (Before we have missing data in the predictors)

In this case, wave does seem to be significant. 

## Model with predictors  

Here we are adding in locale, percent bipoc, and percent frpl as predictors in our model. 

```{r predictors, warning=FALSE, message=FALSE}

GLMMfix <- glmer(prac_tot ~ 1 + wave + locale + cbipoc_percent + cfrpl_percent + (1|school_id), 
                  family = poisson, 
                  data = main) 

## No interaction term here
summary(GLMMfix)
tab_model(GLMMfix)
```

### Model check Conditional 
Is this any better than the unconditional model? 

```{r conditional check, warning=FALSE, message=FALSE}

AIC(GLMMCond,GLMMfix)
BIC(GLMMCond,GLMMfix)

# Cannot test comparison because different proportion of missing data between the models.
# test_lrt(GLMMCond,GLMMfix) 

```

The model with predictors is better than the conditional model according to the AIC and BIC. 

## Model Interactions   
**Locale x Wave**    

The previous model did not have an interaction effect. In this model we have the interaction between wave and locale but not of percent bipoc and percent frpl.  


```{r interaction, warning=FALSE, message=FALSE}


GLMMfix1 <- glmer(prac_tot ~ 1 + wave + 
                    locale + 
                    cbipoc_percent + 
                    cfrpl_percent + 
                    locale*wave +
                    (1|school_id), 
                  family = poisson, 
                  data = main) 
summary(GLMMfix1)
tab_model(GLMMfix1)


```

**ICC: 0.20**

**Marginal R^2: 0.235 (23.5% of variance explained)**

**Conditional R^2: 0.388 (38.8% of variance explained)**

In this model it seems like the interaction between wave and urban location was significant but not for suburban and wave. 

### Model check Interaction   
Is this any better than the model without the interaction term? 

```{r interaction check, warning=FALSE, message=FALSE}

AIC(GLMMfix,GLMMfix1)
BIC(GLMMfix,GLMMfix1)

  
test_lrt(GLMMfix,GLMMfix1) 

```

Based on AIC and BIC the model without the interaction term is a better model but barely, it is so very very close: p = 0.051.  

## Predictors of growth  

Here we add a model with interaction effects between not only locale but percent bipoc and percent frpl as well.  

```{r interactions, warning=FALSE, message=FALSE}

GLMMfix2 <- glmer(prac_tot ~ 1 + wave + 
                    locale + 
                    cbipoc_percent + 
                    cfrpl_percent + 
                    locale*wave +
                    cbipoc_percent*wave +
                    cfrpl_percent*wave +
                    (1|school_id), 
                  family = poisson, 
                  data = main) 
summary(GLMMfix2)

## Model failed to converge with optimizer. Can check afix package for optimizers later.

```


### Model check Interactions   
**Interaction: Wave X Locale , Wave X Percent FRPL , Wave X Percent BIPOC**

```{r interactions check, warning=FALSE, message=FALSE}

AIC(GLMMfix1,GLMMfix2)
BIC(GLMMfix1,GLMMfix2)

test_lrt(GLMMfix1,GLMMfix2)

```

The second model does not seem to be better which would make sense given that we likely wouldn't expect percent frpl and percent bipoc to change significantly in a short timeframe and adding the interactions of those two with wave increased our degrees of freedom.

# Plots  

**Not using a model**
```{r, warning=FALSE, message=FALSE}
localegg <- summarySE(na.omit(main), measurevar="prac_tot", groupvars=c("locale","wave")) 

localegg$wave<-as.numeric(localegg$wave)

# The errorbars overlapped, so use position_dodge to move them horizontally
pd <- position_dodge(0.1) # move them .05 to the left and right

# Use 95% confidence interval instead of SEM

ggplot(localegg, aes(x=wave, y=prac_tot, color=locale)) + 
  geom_errorbar(aes(ymin=prac_tot-ci, ymax=prac_tot+ci), width=.1, position=pd) +
  ylab("Total Practices") +
  ylim(0,9) +
  geom_line(position=pd) +
  geom_point(position=pd) + theme_classic() + 
  scale_color_manual(values=c("cornflowerblue", "chocolate1", "darkorchid2")) +
  ggtitle("Locale x Group By Time with 95% Mean CIs") +
  theme(plot.title = element_text(hjust = 0.5, lineheight=.8, face="bold"))
  

```

## No Interaction Model  

```{r, warning=FALSE, message=FALSE}
plot_model(GLMMfix) + theme_classic () 

plot_model(GLMMfix,type = "eff")$wave + theme_classic () # plot the effect of Time (Wave) 

plot_model(GLMMfix,type = "eff")$locale + theme_classic () # plot the effect of locale 
 
interact_plot(model=GLMMfix, pred = wave, modx = locale) # Enter the predictor of growth in the final model 
```


## Interaction Model

```{r, warning=FALSE, message=FALSE}
plot_model(GLMMfix1) + theme_classic () 

plot_model(GLMMfix1,type = "eff")$wave + theme_classic () # plot the effect of Time (Wave) 

plot_model(GLMMfix1,type = "eff")$locale + theme_classic () # plot the effect of locale 
 
interact_plot(model=GLMMfix1, pred = wave, modx = locale) # Enter the predictor of growth in the final model 
```



# Tab Models  

## No interaction Model  
**Using the Predictor model with no interaction term**
Rated as the best model based on test of fit and BIC.  

```{r tab model pred}

tab_model(GLMMfix)

```

## Interaction Model  
**Using the Predictor model with an interaction term between Locale X Wave**
Better according to AIC  

```{r tab model inter}

tab_model(GLMMfix1)

```


# Imputed Data

If needed, here is the model with imputed data, if the MCAR test determines that the missing data is not at random. 

## Missing data  
**Examines the missing data in the main dataset**  

```{r}
library(lmerTest)
library(mice)
library(broom.mixed)
library(mitml)

main_missing <- main %>% select(school_name, school_state, prac_tot, wave, bipoc_percent, frpl_percent, locale)
md.pattern(main_missing, rotate.names = T)


```

Tells us where the missing data. 442 complete observations.

## Imputed data
This is the imputed data that tries to compensate for the missing data. Although our missing data is not completely at random, we are going to run the model to compare.  

```{r, warning=FALSE, message=FALSE}
#Someone online suggested this package to impute data

#### Impute ####
imp <- mice(main,
            m=5)

#### Fit With Imputations ####
fit <- with(imp,
            glmer(prac_tot ~ wave + locale +
                   cbipoc_percent+
                   cfrpl_percent+
                   (1|school_id)))

#### Pool and Summarise ####
pool <- pool(fit)
summary(pool)

#### Load Library and Get All Estimates ####
testEstimates(as.mitml.result(fit),
              extra.pars = T)
```

Compare imputed model and out model (missing data)



